---
title: "Analysis - Border risk"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Analysis - Border risk}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(riskintroanalysis)
library(riskintrodata)
library(dplyr)
library(sf)
library(ggplot2)
```

## Introduction

**Border risk** quantifies the risk of disease introduction through shared land borders with neighboring countries. The core principle is simple: the longer the border shared with a high-risk country, the greater the risk of disease introduction.

This method accounts for two key factors:

1. The **emission risk** of neighboring countries (how risky each neighbor is)
2. The **length of shared borders** (how much exposure each epidemiological unit has)

For epidemiological units that border only one country, the risk equals that country's emission risk. For units bordering multiple countries, the risk is a weighted average based on border lengths.

## Required Data

This analysis requires three datasets:

1. **Epidemiological units** - the geographic areas being analyzed
2. **Emission risk scores** - risk levels for neighboring countries
3. **Shared border lengths** - calculated from the epidemiological units

## Preparing the Data

### Epidemiological Units

First, we load and validate the epidemiological units dataset. For this example, we use Tunisia's administrative divisions at the second level (governorates).

```{r epi-units}
# Load raw geospatial data
tunisia_raw <- read_sf(system.file(
  package = "riskintrodata",
  "samples", "tunisia", "epi_units", "tunisia_adm2_raw.gpkg"
))

# Validate and standardize column names
tunisia <- validate_dataset(
  x = tunisia_raw,
  table_name = "epi_units",
  eu_name = "NAME_2",
  geometry = "geom"
) |> extract_dataset()

plot(sf::st_geometry(tunisia))
```

### Emission Risk Scores

Tunisia shares borders with two countries: Algeria and Libya. We need emission risk scores for both. Here we create example entries for these countries and combine them with WAHIS data for context.

```{r emission-risk}
# Create emission risk entry for Algeria
algeria <- erf_row(
  iso3 = "DZA",
  country = "Algeria",
  disease = "Avian infectious laryngotracheitis",
  animal_category = "Domestic",
  species = "Birds",
  disease_notification = 0,
  targeted_surveillance = 1,
  general_surveillance = 0,
  screening = 1,
  precautions_at_the_borders = 1,
  slaughter = 1,
  selective_killing_and_disposal = 1,
  zoning = 1,
  official_vaccination = 1,
  last_outbreak_end_date = as.Date("30/06/2023"),
  commerce_illegal = 0L,
  commerce_legal = 0L
)

# Create emission risk entry for Libya
libya <- erf_row(
  iso3 = "LBY",
  country = "Libya",
  disease = "Avian infectious laryngotracheitis",
  animal_category = "Domestic",
  species = "Birds",
  disease_notification = TRUE,
  targeted_surveillance = 1,
  general_surveillance = 0,
  screening = 1,
  precautions_at_the_borders = 0,
  slaughter = 1,
  selective_killing_and_disposal = 1,
  zoning = 1,
  official_vaccination = 1,
  last_outbreak_end_date = as.Date("30/06/2019"),
  commerce_illegal = 0L,
  commerce_legal = 1
)

# Get WAHIS data for additional countries
wahis_erf <- get_wahis_erf(
  disease = "Avian infectious laryngotracheitis",
  animal_category = "Domestic",
  species = "Birds"
)

# Combine all emission risk factors
emission_risk_factors <- dplyr::bind_rows(
  algeria,
  libya,
  wahis_erf
)

# Calculate final emission risk scores
emission_risk_table <- calc_emission_risk(emission_risk_factors = emission_risk_factors)
```

For more details on creating emission risk scores, see the [emission scores vignette](emission-scores.html).

## Calculating Shared Borders

The first step in border risk analysis is identifying and measuring shared borders between epidemiological units and neighboring countries. This is non-trivial because geospatial data from different sources often has misaligned borders.

The `calc_border_lengths()` function corrects these misalignments by treating the epidemiological units as the "true" borders and aligning the neighboring country borders to match.

```{r shared-borders}
# Calculate shared border lengths
shared_borders <- calc_border_lengths(
  epi_units = tunisia
)

# Visualize the borders
bordering_countries <- riskintrodata::neighbours_table |>
  filter(country_id == "TUN") |>
  right_join(riskintrodata::world_sf, by = c("neighbour_id" = "iso3"))

ggplot() +
  geom_sf(data = bordering_countries, colour = "red", fill = "pink", alpha = 0.5, aes(geometry = geometry)) +
  geom_sf(data = tunisia, fill = "lightblue", colour = "blue", alpha = 0.5) +
  geom_sf(data = shared_borders, colour = "black") +
  geom_sf_label(data = shared_borders, aes(label = sprintf("%.fkm", border_length)), size = 1.5) +
  coord_sf(xlim = c(7, 12), ylim = c(30, 38), expand = FALSE)
```

The map shows the shared borders as thick black lines with their lengths labeled in kilometers. Notice how some Tunisia governorates share borders with both Algeria and Libya.

## Calculating Border Risk

Now we can calculate the border risk for each epidemiological unit. The calculation follows this logic:

- For units bordering **one country**: risk = that country's emission risk
- For units bordering **multiple countries**: risk = weighted average of emission risks, weighted by border length

```{r border-risk-analysis}
ri_borders <- calc_border_risk(
  epi_units = tunisia,
  shared_borders = shared_borders,
  emission_risk = emission_risk_table
)

plot_risk(ri_borders)
```

## Interpreting the Results

The map shows risk values for each governorate. Most have a single color corresponding to their sole neighbor (either Algeria or Libya).

The southernmost governorate (Remada) is particularly interesting: it borders both Algeria and Libya, so its risk is a weighted average. If it shares 60km with Algeria (emission risk = 8) and 40km with Libya (emission risk = 5), the calculation would be:

$$
\text{risk} = \frac{(60 \times 8) + (40 \times 5)}{60 + 40} = \frac{480 + 200}{100} = 6.8
$$

This weighted averaging ensures that governorates with longer borders to high-risk countries receive appropriately higher risk scores.

## Interactive Map

For interactive exploration, we can create a leaflet map that allows zooming and panning:

```{r interactive-map}
library(leaflet)

plot_risk_interactive(ri_borders)
```

Click on any governorate to see its exact risk score and other details. The color scale shows relative risk levels across all units.